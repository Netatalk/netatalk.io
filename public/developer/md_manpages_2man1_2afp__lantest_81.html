<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>netatalk: Name</title>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">netatalk<span id="projectnumber">&#160;4.4.0dev</span>
   </div>
   <div id="projectbrief">Free and Open Source Apple Filing Protocol (AFP) Server</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_manpages_2man1_2afp__lantest_81.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Name </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md73"></a></p>
<p>afp_lantest â€” AFP LAN performance and directory cache testing tool</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md74"></a>
Synopsis</h1>
<p><b>afp_lantest</b> [-34567bcGgKVv] [-h <em>host</em>] [-p <em>port</em>] [-s <em>volume</em>] [-u <em>user</em>] [-w <em>password</em>] [-n <em>iterations</em>] [-f <em>tests</em>] [-F <em>bigfile</em>]</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md75"></a>
Description</h1>
<p><b>afp_lantest</b> is a comprehensive AFP (Apple Filing Protocol) performance testing tool designed to benchmark various aspects of AFP servers, including directory cache performance in netatalk.</p>
<p>The tool runs a series of tests that measure file operations, directory traversal, and caching efficiency. It includes both traditional file system benchmarks and specialized cache-focused tests that highlight the benefits of optimized directory cache validation and probabilistic validation features.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md76"></a>
Options</h1>
<p><b>-3</b> : Use AFP 3.0 protocol version</p>
<p><b>-4</b> : Use AFP 3.1 protocol version</p>
<p><b>-5</b> : Use AFP 3.2 protocol version</p>
<p><b>-6</b> : Use AFP 3.3 protocol version</p>
<p><b>-7</b> : Use AFP 3.4 protocol version (default)</p>
<p><b>-b</b> : Debug mode</p>
<p><b>-c</b> : Output results in CSV format (default: tabular)</p>
<p><b>-F</b> <em>bigfile</em> : Use existing file in volume root for read test (file size must match -g/-G options)</p>
<p><b>-f</b> <em>tests</em> : Specific tests to run, specified as digits (e.g., "134" runs tests 1, 3, and 4)</p>
<p><b>-G</b> : Optimize for 10-gigabit networks (increases file test size to 10 GB)</p>
<p><b>-g</b> : Optimize for gigabit networks (increases file test size to 1 GB)</p>
<p><b>-h</b> <em>host</em> : Server hostname or IP address (default: localhost)</p>
<p><b>-K</b> : Run cache-focused tests only (tests 9-12)</p>
<p><b>-n</b> <em>iterations</em> : Number of test iterations to run (default: 2). For iterations &gt; 5 outliers will be removed</p>
<p><b>-p</b> <em>port</em> : Server port number (default: 548)</p>
<p><b>-s</b> <em>volume</em> : Volume name to mount for testing</p>
<p><b>-u</b> <em>user</em> : Username for authentication (default: current uid)</p>
<p><b>-V</b> : Very verbose output</p>
<p><b>-v</b> : Verbose output</p>
<p><b>-w</b> <em>password</em> : Password for authentication</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md77"></a>
Configuration</h1>
<p>The test runner AFP client only supports the ClearTxt UAM currently. Configure the UAM in netatalk's afp.conf: </p><pre class="fragment">[Global]
uam list = uams_clrtxt.so
</pre><h1 class="doxsection"><a class="anchor" id="autotoc_md78"></a>
Available Tests</h1>
<p>The following tests are available:</p>
<p><b>(1) Opening, stating and reading 512 bytes from 1000 files</b> : Tests basic file access patterns with many small operations</p>
<p><b>(2) Writing one large file</b> : Measures sustained write performance</p>
<p><b>(3) Reading one large file</b> : Measures sustained read performance</p>
<p><b>(4) Locking/Unlocking 10000 times each</b> : Tests file locking performance</p>
<p><b>(5) Creating dir with 2000 files</b> : Tests directory creation and file creation performance</p>
<p><b>(6) Enumerate dir with 2000 files</b> : Tests directory enumeration with many files</p>
<p><b>(7) Deleting dir with 2000 files</b> : Tests directory and file deletion performance</p>
<p><b>(8) Create directory tree with 1000 dirs</b> : Tests nested directory creation</p>
<p><b>(9) Directory cache hits [CACHE]</b> : Tests directory and file lookup performance (1000 dirs + 10000 files)</p>
<p><b>(10) Mixed cache operations [CACHE]</b> : Tests mixed create/stat/enum/delete operations</p>
<p><b>(11) Deep path traversal [CACHE]</b> : Tests performance with deep directory structures</p>
<p><b>(12) Cache validation [CACHE]</b> : Tests directory cache validation mechanisms</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md79"></a>
Cache-Focused Tests</h2>
<p>Tests 9-12 are specifically designed to highlight directory cache performance improvements in netatalk. These tests benefit significantly from optimized cache validation and probabilistic validation features. Use the <b>-K</b> option to run only these cache-focused tests.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md80"></a>
Examples</h1>
<p>Run all tests with default settings: </p><pre class="fragment">afp_lantest -h server.example.com -u testuser -w password -s TestVolume
</pre><p>Run only cache-focused tests: </p><pre class="fragment">afp_lantest -K -h server.example.com -u testuser -w password -s TestVolume
</pre><p>Run specific tests (file operations): </p><pre class="fragment">afp_lantest -f 123 -h server.example.com -u testuser -w password -s TestVolume
</pre><p>Run tests optimized for gigabit network: </p><pre class="fragment">afp_lantest -g -h server.example.com -u testuser -w password -s TestVolume
</pre><p>Run multiple iterations for statistical analysis: </p><pre class="fragment">afp_lantest -n 5 -h server.example.com -u testuser -w password -s TestVolume
</pre><h1 class="doxsection"><a class="anchor" id="autotoc_md81"></a>
Example with IO Monitoring</h1>
<p>IO Monitoring (Linux only) requires proc filesystem mounted at /proc_io with hidepid=0. Set <em>gid</em> to the group ID of the user running afp_lantest.</p>
<p>For example, to run as root; <span class="tt">mkdir -p /proc_io &amp;&amp; mount -t proc -o hidepid=0,gid=0 proc /proc_io</span> </p><pre class="fragment">afp_lantest -n 2 -7 -h 127.0.0.1 -p 548 -u test -w test -s 'File Sharing'
Connecting to host 127.0.0.1:548
IO monitoring: /proc_io is available
Found cnid_dbd process for user 'test': PID 40
Found privilege-dropped afpd process for user 'test': PID 36
IO monitoring enabled (afpd: 36, cnid_dbd: 40)

Run 1 =&gt; Open, stat and read 512 bytes from 1000 files [8,000 AFP ops]        4230 ms
        IO Operations; afpd: 6000 READs, 7002 WRITEs | cnid_dbd: 0 READs, 2 WRITEs
Run 1 =&gt; Writing one large file [103 AFP ops]                                  166 ms for 100 MB (avg. 631 MB/s)
        IO Operations; afpd: 0 READs, 299 WRITEs | cnid_dbd: 0 READs, 0 WRITEs
Run 1 =&gt; Reading one large file [102 AFP ops]                                   55 ms for 100 MB (avg. 1906 MB/s)
        IO Operations; afpd: 100 READs, 100 WRITEs | cnid_dbd: 0 READs, 0 WRITEs
Run 1 =&gt; Locking/Unlocking 10000 times each [20,000 AFP ops]                   859 ms
        IO Operations; afpd: 0 READs, 20000 WRITEs | cnid_dbd: 0 READs, 0 WRITEs
Run 1 =&gt; Creating dir with 2000 files [4,000 AFP ops]                         4927 ms
        IO Operations; afpd: 2000 READs, 10006 WRITEs | cnid_dbd: 4 READs, 6151 WRITEs
Run 1 =&gt; Enumerate dir with 2000 files [~51 AFP ops]                          1740 ms
        IO Operations; afpd: 1959 READs, 50 WRITEs | cnid_dbd: 0 READs, 2 WRITEs
Run 1 =&gt; Deleting dir with 2000 files [2,000 AFP ops]                         3362 ms
        IO Operations; afpd: 4000 READs, 4004 WRITEs | cnid_dbd: 4 READs, 6177 WRITEs
Run 1 =&gt; Create directory tree with 1000 dirs [1,110 AFP ops]                 2081 ms
        IO Operations; afpd: 0 READs, 4445 WRITEs | cnid_dbd: 2 READs, 2279 WRITEs
Run 1 =&gt; Directory cache hits (100 dirs + 1000 files) [11,000 AFP ops]        5552 ms
        IO Operations; afpd: 10000 READs, 11100 WRITEs | cnid_dbd: 0 READs, 100 WRITEs
Run 1 =&gt; Mixed cache operations (create/stat/enum/delete) [820 AFP ops]       1215 ms
        IO Operations; afpd: 820 READs, 1623 WRITEs | cnid_dbd: 0 READs, 1203 WRITEs
Run 1 =&gt; Deep path traversal (nested directory navigation) [3,500 AFP ops]    1835 ms
        IO Operations; afpd: 2500 READs, 3550 WRITEs | cnid_dbd: 0 READs, 50 WRITEs
Run 1 =&gt; Cache validation efficiency (metadata changes) [30,000 AFP ops]     14559 ms
        IO Operations; afpd: 30000 READs, 30100 WRITEs | cnid_dbd: 0 READs, 100 WRITEs
Run 2 =&gt; Open, stat and read 512 bytes from 1000 files [8,000 AFP ops]        3801 ms
        IO Operations; afpd: 6000 READs, 7005 WRITEs | cnid_dbd: 0 READs, 5 WRITEs
Run 2 =&gt; Writing one large file [103 AFP ops]                                  115 ms for 100 MB (avg. 911 MB/s)
        IO Operations; afpd: 0 READs, 299 WRITEs | cnid_dbd: 0 READs, 0 WRITEs
Run 2 =&gt; Reading one large file [102 AFP ops]                                   47 ms for 100 MB (avg. 2231 MB/s)
        IO Operations; afpd: 100 READs, 100 WRITEs | cnid_dbd: 0 READs, 0 WRITEs
Run 2 =&gt; Locking/Unlocking 10000 times each [20,000 AFP ops]                  1061 ms
        IO Operations; afpd: 0 READs, 20000 WRITEs | cnid_dbd: 0 READs, 0 WRITEs
Run 2 =&gt; Creating dir with 2000 files [4,000 AFP ops]                         4739 ms
        IO Operations; afpd: 2000 READs, 10005 WRITEs | cnid_dbd: 7 READs, 6141 WRITEs
Run 2 =&gt; Enumerate dir with 2000 files [~51 AFP ops]                          1279 ms
        IO Operations; afpd: 1959 READs, 50 WRITEs | cnid_dbd: 0 READs, 1 WRITEs
Run 2 =&gt; Deleting dir with 2000 files [2,000 AFP ops]                         3470 ms
        IO Operations; afpd: 4000 READs, 4004 WRITEs | cnid_dbd: 4 READs, 6182 WRITEs
Run 2 =&gt; Create directory tree with 1000 dirs [1,110 AFP ops]                 2030 ms
        IO Operations; afpd: 0 READs, 4445 WRITEs | cnid_dbd: 2 READs, 2272 WRITEs
Run 2 =&gt; Directory cache hits (100 dirs + 1000 files) [11,000 AFP ops]        7074 ms
        IO Operations; afpd: 10000 READs, 11100 WRITEs | cnid_dbd: 0 READs, 100 WRITEs
Run 2 =&gt; Mixed cache operations (create/stat/enum/delete) [820 AFP ops]       1227 ms
        IO Operations; afpd: 820 READs, 1622 WRITEs | cnid_dbd: 2 READs, 1243 WRITEs
Run 2 =&gt; Deep path traversal (nested directory navigation) [3,500 AFP ops]    1258 ms
        IO Operations; afpd: 2500 READs, 3550 WRITEs | cnid_dbd: 0 READs, 50 WRITEs
Run 2 =&gt; Cache validation efficiency (metadata changes) [30,000 AFP ops]     20181 ms
        IO Operations; afpd: 30000 READs, 30100 WRITEs | cnid_dbd: 0 READs, 100 WRITEs
Successfully deleted test directory 'LanTest-35'

Netatalk Lantest Results (Averages and standard deviations (Â±) for all tests, across 2 iterations (default))
============================================================================================================

Test                                                                Time_ms  TimeÂ± AFPD_R AFPD_RÂ± AFPD_W AFPD_WÂ± CNID_R CNID_RÂ± CNID_W CNID_WÂ±   MB/s
------------------------------------------------------------------ -------- ------ ------ ------- ------ ------- ------ ------- ------ ------- ------
Open, stat and read 512 bytes from 1000 files [8,000 AFP ops]          4015  303.3   6000     0.0   7003     2.2      0     0.0      3     2.2      0
Writing one large file [103 AFP ops]                                    140   36.1      0     0.0    299     0.0      0     0.0      0     0.0    714
Reading one large file [102 AFP ops]                                     51    5.7    100     0.0    100     0.0      0     0.0      0     0.0   1960
Locking/Unlocking 10000 times each [20,000 AFP ops]                     960  142.8      0     0.0  20000     0.0      0     0.0      0     0.0      0
Creating dir with 2000 files [4,000 AFP ops]                           4833  132.9   2000     0.0  10005     1.0      5     2.2   6146     7.1      0
Enumerate dir with 2000 files [~51 AFP ops]                            1509  326.0   1959     0.0     50     0.0      0     0.0      1     1.0      0
Deleting dir with 2000 files [2,000 AFP ops]                           3416   76.4   4000     0.0   4004     0.0      4     0.0   6179     3.6      0
Create directory tree with 1000 dirs [1,110 AFP ops]                   2055   36.1      0     0.0   4445     0.0      2     0.0   2275     5.0      0
Directory cache hits (100 dirs + 1000 files) [11,000 AFP ops]          6313 1076.2  10000     0.0  11100     0.0      0     0.0    100     0.0      0
Mixed cache operations (create/stat/enum/delete) [820 AFP ops]         1221    8.5    820     0.0   1622     1.0      2     0.0   1223    28.3      0
Deep path traversal (nested directory navigation) [3,500 AFP ops]      1546  408.0   2500     0.0   3550     0.0      0     0.0     50     0.0      0
Cache validation efficiency (metadata changes) [30,000 AFP ops]       17370 3975.4  30000     0.0  30100     0.0      0     0.0    100     0.0      0
------------------------------------------------------------------ -------- ------ ------ ------- ------ ------- ------ ------- ------ ------- ------
Sum of all AFP OPs = 80686                                            43429         57379          92278             13          16077               

Aggregates Summary:
------------------------------------------------------------------
Average Time per AFP OP: 0.538 ms
Average AFPD Reads per AFP OP: 0.711
Average AFPD Writes per AFP OP: 1.144
See afp_lantest manpage for more information: https://netatalk.io/manual/en/afp_lantest.1

Dircache Statistics (/var/log/afpd.log):
------------------------------------------------------------------
Sep 24 13:30:15.702673 afpd[36] {dircache.c:632} (info:AFPDaemon): dircache statistics: (user: test) entries: 0, lookups: 244476, hits: 227977 (93.3%), misses: 9228, added: 9552, removed: 9552, expunged: 7271, evicted: 0
</pre><h2 class="doxsection"><a class="anchor" id="autotoc_md82"></a>
IO Monitoring Result Columns</h2>
<pre class="fragment">Time(ms) = Test runtime in milliseconds
TimeÂ±    = Test runtime standard deviation
AFPD_R   = afpd process IO Read operations
AFPD_RÂ±  = afpd process IO Read operation standard deviation
AFPD_W   = afpd process IO Write operations
AFPD_WÂ±  = afpd process IO Write operation standard deviation

CNID_*   = IO measurements for the cnid_dbd process (optional)
</pre><p>Note; When measuring afpd read/write IO with afp_lantest, ensure afp.conf <span class="tt">log level</span> is set to <span class="tt">default:error</span></p>
<ul>
<li>More verbose logging superficially increases *_W IO values. For dirstats at least <span class="tt">default:info</span> is reqired.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md83"></a>
IO Monitoring Aggregates Summary</h2>
<p>The aggregate values are purely Intrinsic Metrics, as AFP operations are a mixture of reads, writes, and connection related operations.</p>
<p>Therefore the measurements are meaningful only within their own context. They provide a way to assess changes relative to itself, but lack any external coherence or reference point for comparison with other systems.</p>
<p>Generally, values less than 1 indicate efficient operation (for example due to batching and caching etc), and values greater than 1 indicate sub-optimal operation (for example amplification of a single operation, causing additional downstream operations).</p>
<p>Note; As total AFP Ops are a mix of reads, writes, and other ops the effective 1:1 (AFP:IO) thresholds are not equal to 1. Accurate thresholds can be calculated on a per test basis using the information shown in the Testing Wiki, and comparing relevant AFP read/write ops with the relevant AFPD_R/AFPD_W values.</p>
<p>Ideally code changes should observe aggregate values as reducing.</p>
<p>For more information see <a href="https://netatalk.io/docs/Testing">Testing Wiki</a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md84"></a>
Return Codes</h1>
<p><b>0</b> : All tests passed successfully</p>
<p><b>1</b> : One or more tests failed</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md85"></a>
Notes</h1>
<ul>
<li>Tests that involve large file operations (tests 2 and 3) will create temporary files in the test volume</li>
<li>The <b>-g</b> and <b>-G</b> options significantly increase test file sizes and test duration</li>
<li>Cache-focused tests (8-11) provide the most insight into netatalk's directory cache performance</li>
<li>Multiple iterations (<b>-n</b>) are recommended for consistent performance measurements</li>
<li>The tool requires write access to the specified AFP volume</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md86"></a>
See Also</h1>
<p><b>afp_speedtest</b>(1), <b>afpd</b>(8), <b>netatalk</b>(8) </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
