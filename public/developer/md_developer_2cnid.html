<!-- HTML header for doxygen 1.14.0-->
<!-- modified for netatalk -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>netatalk: CNID Database Daemons</title>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<script
    src="https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js"
    integrity="o+g/BxPwhi0C3RK7oQBxQuNimeafQ3GE/ST4iT2BxVI4Wzt60SH4pq9iXVYujjaS"
    crossorigin="anonymous"
></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
  <div id="projectrow">
    <div id="projectlogo">
      <a href="/"><img alt="Logo" src="logo.png"/></a>
    </div>
    <div id="projectalign">
      <div id="projectname">
        netatalk
        <span id="projectnumber">&#160;4.4.0</span>
      </div>
      <div id="projectbrief">Free and Open Source Apple Filing Protocol (AFP) Server</div>
    </div>
  </div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_developer_2cnid.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">CNID Database Daemons </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The CNID database daemons cnid_metad and cnid_dbd are an implementation of the netatalk CNID database support that attempts to put all functionality into separate daemons. There is one cnid_dbd daemon per netatalk volume. The underlying database structure is based on Berkeley DB.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md0"></a>
Advantages</h1>
<ul>
<li>No locking issues or leftover locks due to crashed afpd daemons. Since there is only one thread of control accessing the database, no locking is needed and changes appear atomic.</li>
<li>Berkeley DB transactions are difficult to get right with several processes attempting to access the CNID database simultaneously. This is much easier with a single process and the database can be made nearly crash-proof this way (at a performance cost).</li>
<li>No problems with user permissions and access to underlying database files, the cnid_dbd process runs under a configurable user ID that normally also owns the underlying database and can be contacted by whatever afpd daemon accesses a volume.</li>
<li>If an afpd process crashes, the CNID database is unaffected. If the process was making changes to the database at the time of the crash, those changes will be rolled back entirely (transactions). If the process was not using the database at the time of the crash, no corrective action is necessary. In any case, database consistency is assured.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1"></a>
Disadvantages</h1>
<ul>
<li><p class="startli">Performance in an environment of processes sharing the database (files) is potentially better for two reasons:</p>
<p class="startli">i) IPC overhead. ii) r/o access to database pages is possible by more than one process at once, r/w access is possible for non overlapping regions.</p>
<p class="startli">The current implementation of cnid_dbd uses unix domain sockets as the IPC mechanism. While this is not the fastest possible method, it is very portable and the cnid_dbd IPC mechanisms can be extended to use faster IPC (like mmap) on architectures where it is supported. As a ballpark figure, 20000 requests/replies to the cnid_dbd daemon take about 0.6 seconds on a Pentium III 733 MHz running Linux Kernel 2.4.18 using unix domain sockets. The requests are "empty" (no database lookups/changes), so this is just the IPC overhead.</p>
<p class="startli">I have not measured the effects of the advantages of simultaneous database access.</p>
</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2"></a>
Installation and configuration</h1>
<p>There are two executables that will be built in etc/cnid_dbd and installed into the systems binaries directories of netatalk: cnid_metad and cnid_dbd. cnid_metad should run all the time with root permissions. It will be notified when an instance of afpd starts up and will in turn make sure that a cnid_dbd daemon is started for the volume that afpd wishes to access. The cnid_dbd daemon runs as long as necessary and services any other instances of afpd that access the volume. You can safely kill it with SIGTERM, it will be restarted automatically by cnid_metad as soon as the volume is accessed again.</p>
<p>cnid_dbd changes to the Berkeley DB directory on startup and sets effective UID and GID to owner and group of that directory. Database and supporting files should therefore be writeable by that user/group.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md3"></a>
Current shortcomings</h1>
<ul>
<li>The parameter file parsing of <a class="el" href="structdb__param.html">db_param</a> is very simpleminded. For example, there is no support for blanks (or weird characters) in filenames for the usock_file parameter.</li>
<li>There is no protection against a malicious user connecting to the cnid_dbd socket and changing the database. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- HTML footer for doxygen 1.14.0-->
<!-- modified for netatalk -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
