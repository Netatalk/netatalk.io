<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>netatalk: Docker</title>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">netatalk<span id="projectnumber">&#160;4.4.0dev</span>
   </div>
   <div id="projectbrief">Free and Open Source Apple Filing Protocol (AFP) Server</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2_users_2dmark_2dev_2netatalk_2_d_o_c_k_e_r.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Docker </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md458"></a></p>
<p>Netatalk comes with a Dockerfile and entry point script for running a containerized AFP server and AppleTalk services.</p>
<p>Out of the box, exactly two users, and two shared volumes are supported in this container. One of the shared volumes is a backup volume by default. If you need a different setup, please use the manual configuration option.</p>
<p>Make sure you have a container runtime installed, then build the netatalk container:</p>
<div class="fragment"><div class="line">docker build -t netatalk:latest .</div>
</div><!-- fragment --><p>Alternatively, pull a pre-built Docker image from <a href="https://hub.docker.com/u/netatalk">Docker Hub</a>.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md459"></a>
How to Run</h1>
<p>Once you have the netatalk image on your machine run it with <span class="tt">docker</span>, <span class="tt">podman</span> or equivalent container runtime.</p>
<p>The easiest way to enable full functionality including Zeroconf service discovery and AppleTalk is to use the <span class="tt">host</span> network driver.</p>
<p>For a hardened deployment, use the <span class="tt">bridge</span> network driver and expose port 548 for AFP. However, Zeroconf service discovery may not work and you will have to manually specify the IP address in the client when connecting to the file server.</p>
<p>It is recommended to set up either a bind mount, or a Docker managed volume for persistent storage. Without this, the shared volume be stored in volatile storage that is lost upon container shutdown.</p>
<p>For Docker Compose, you can use the sample <a href="https://github.com/Netatalk/netatalk/blob/main/docker-compose.yml">docker-compose.yml</a> file that is distributed with this source code.</p>
<p>Below follows a sample <span class="tt">docker run</span> command. Substitute <span class="tt">/path/to/share</span> with an actual path on your file system with appropriate permissions, <span class="tt">AFP_USER</span> and <span class="tt">AFP_PASS</span> with the appropriate user and password, and <span class="tt">ATALKD_INTERFACE</span> with the network interface to use for AppleTalk.</p>
<p>You also need to set the timezone with <span class="tt">TZ</span> to the <a href="https://nodatime.org/TimeZones">IANA time zone ID</a> for your location, in order to get the correct time synchronized with the Timelord time server.</p>
<div class="fragment"><div class="line">docker run --rm \</div>
<div class="line">  --network host \</div>
<div class="line">  --cap-add=NET_ADMIN \</div>
<div class="line">  --volume &quot;/path/to/share:/mnt/afpshare&quot; \</div>
<div class="line">  --volume &quot;/path/to/backup:/mnt/afpbackup&quot; \</div>
<div class="line">  --volume &quot;/var/run/dbus:/var/run/dbus&quot; \</div>
<div class="line">  --env AFP_USER= \</div>
<div class="line">  --env AFP_PASS= \</div>
<div class="line">  --env AFP_GROUP=afpusers \</div>
<div class="line">  --env ATALKD_INTERFACE=eth0 \</div>
<div class="line">  --env TZ=Europe/Stockholm \</div>
<div class="line">  --name netatalk netatalk:latest</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md460"></a>
Constraints</h1>
<p>The most straight forward way to enable Zeroconf service discovery as well as the AppleTalk transport layer, is to use the <span class="tt">host</span> network driver and <span class="tt">NET_ADMIN</span> capabilities.</p>
<p>Additionally, we rely on the host's D-Bus for Zeroconf, achieved with a bind mount such as <span class="tt">/var/run/dbus:/var/run/dbus</span>. The left hand side of the bind mount is the host machine, and the right hand side is the container. The host machine path may have to be changed to match the location of D-Bus on the host machine.</p>
<p>On certain host OSes, notably Ubuntu: if the Apparmor security policy restricts D-Bus messages, enable the <span class="tt">unconfined</span> security option.</p>
<p>Example for the docker compose yaml configuration file:</p>
<div class="fragment"><div class="line">security_opt:</div>
<div class="line">  - apparmor=unconfined</div>
</div><!-- fragment --><p>See the <a href="https://docs.docker.com/engine/security/apparmor/">Docker AppArmor security profiles documentation</a> for further details.</p>
<p>The container is hard coded to output <span class="tt">afpd</span> (the Netatalk file server daemon) logs to the container's stdout, with default log level <span class="tt">info</span>. Logs from the AppleTalk daemons are sent to the syslog.</p>
<p>Spotlight compatible search is currently not supported in a containerized environment due to constraints when running file system indexing on the D-Bus.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md461"></a>
MySQL CNID Backend</h1>
<p>The MySQL CNID backend is an alternative to the default Berkeley DB CNID backend which offers better scalability.</p>
<p>Here follows a Docker Compose example to run a container network with MariaDB as the database for the MySQL CNID backend, plus a web interface to administer the database for good measure.</p>
<p>Set <span class="tt">AFP_CNID_SQL_PASS</span> and <span class="tt">MARIADB_ROOT_PASSWORD</span> to the same password.</p>
<div class="fragment"><div class="line">services:</div>
<div class="line">  netatalk:</div>
<div class="line">    image: netatalk:latest</div>
<div class="line">    networks:</div>
<div class="line">      - afp_network</div>
<div class="line">    ports:</div>
<div class="line">      - &quot;548:548&quot;</div>
<div class="line">    volumes:</div>
<div class="line">      - afpshare:/mnt/afpshare</div>
<div class="line">      - afpbackup:/mnt/afpbackup</div>
<div class="line">      - /var/run/dbus:/var/run/dbus</div>
<div class="line">    environment:</div>
<div class="line">      - AFP_USER=atalk1</div>
<div class="line">      - AFP_USER2=atalk2</div>
<div class="line">      - AFP_PASS=</div>
<div class="line">      - AFP_PASS2=</div>
<div class="line">      - AFP_GROUP=afpusers</div>
<div class="line">      - AFP_CNID_BACKEND=mysql</div>
<div class="line">      - AFP_CNID_SQL_HOST=cnid_db</div>
<div class="line">      - AFP_CNID_SQL_PASS=</div>
<div class="line">    depends_on:</div>
<div class="line">      - cnid_db</div>
<div class="line"> </div>
<div class="line">  cnid_db:</div>
<div class="line">    image: mariadb:latest</div>
<div class="line">    restart: always</div>
<div class="line">    networks:</div>
<div class="line">      - afp_network</div>
<div class="line">    volumes:</div>
<div class="line">      - cnid_db_data:/var/lib/mysql</div>
<div class="line">    environment:</div>
<div class="line">      - MARIADB_ROOT_PASSWORD=</div>
<div class="line"> </div>
<div class="line">  adminer:</div>
<div class="line">    image: adminer:latest</div>
<div class="line">    restart: always</div>
<div class="line">    networks:</div>
<div class="line">      - afp_network</div>
<div class="line">    ports:</div>
<div class="line">      - 8081:8080</div>
<div class="line"> </div>
<div class="line">volumes:</div>
<div class="line">  afpshare:</div>
<div class="line">    name: afpshare</div>
<div class="line">  afpbackup:</div>
<div class="line">    name: afpbackup</div>
<div class="line">  cnid_db_data:</div>
<div class="line">    name: cnid_db_data</div>
<div class="line"> </div>
<div class="line">networks:</div>
<div class="line">  afp_network:</div>
<div class="line">    driver: bridge</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md462"></a>
Webmin Module</h1>
<p>Netatalk's Webmin module is distributed as a separate container image. The module allows you to administer the Netatalk configuration via a web interface. Here follows an example Docker Compose configuration to run the module in a container.</p>
<p>Note that since the netatalk daemons run in a separate container, we cannot control the services directly. Instead, activate polling of changes to the afp.conf configuration file. Set <span class="tt">AFP_CONFIG_POLLING</span> to the number of seconds to wait between polling attempts.</p>
<div class="fragment"><div class="line">services:</div>
<div class="line">  netatalk:</div>
<div class="line">    image: netatalk:latest</div>
<div class="line">    networks:</div>
<div class="line">      - afp_network</div>
<div class="line">    ports:</div>
<div class="line">      - &quot;548:548&quot;</div>
<div class="line">    volumes:</div>
<div class="line">      - afpshare:/mnt/afpshare</div>
<div class="line">      - afpbackup:/mnt/afpbackup</div>
<div class="line">      - afpconf:/etc/netatalk</div>
<div class="line">      - /var/run/dbus:/var/run/dbus</div>
<div class="line">    environment:</div>
<div class="line">      - AFP_USER=atalk1</div>
<div class="line">      - AFP_USER2=atalk2</div>
<div class="line">      - AFP_PASS=</div>
<div class="line">      - AFP_PASS2=</div>
<div class="line">      - AFP_GROUP=afpusers</div>
<div class="line">      - AFP_CONFIG_POLLING=5</div>
<div class="line">      - MANUAL_CONFIG=1</div>
<div class="line"> </div>
<div class="line">  webmin:</div>
<div class="line">    image: netatalk_webmin_module:latest</div>
<div class="line">    networks:</div>
<div class="line">      - afp_network</div>
<div class="line">    ports:</div>
<div class="line">      - &quot;10000:10000&quot;</div>
<div class="line">    volumes:</div>
<div class="line">      - afpconf:/etc/netatalk</div>
<div class="line">      - /var/run/docker.sock:/var/run/docker.sock</div>
<div class="line">    environment:</div>
<div class="line">      - WEBMIN_USER=admin</div>
<div class="line">      - WEBMIN_PASS=</div>
<div class="line">    depends_on:</div>
<div class="line">      - netatalk</div>
<div class="line"> </div>
<div class="line">volumes:</div>
<div class="line">  afpshare:</div>
<div class="line">    name: afpshare</div>
<div class="line">  afpbackup:</div>
<div class="line">    name: afpbackup</div>
<div class="line">  afpconf:</div>
<div class="line">    name: afpconf</div>
<div class="line"> </div>
<div class="line">networks:</div>
<div class="line">  afp_network:</div>
<div class="line">    driver: bridge</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md463"></a>
Printing</h1>
<p>The CUPS administrative web app is running on port 631 in the container, which is exposed to the host machine by default when using the <span class="tt">host</span> network driver. This is used to configure CUPS compatible printers for printing from an old Mac or Apple IIGS.</p>
<p>You may have to restart papd (or the entire container) after adding a CUPS printer for it to be picked up as an AppleTalk printer.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md464"></a>
Environment Variables</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md465"></a>
Mandatory</h2>
<p>These are required to set the credentials used to authenticate with the file server.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Variable  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_USER  </td><td class="markdownTableBodyNone">Primary user of the shared volumes  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">AFP_PASS  </td><td class="markdownTableBodyNone">Password to authenticate with the primary user (8 chars or less when using INSECURE_AUTH)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_GROUP  </td><td class="markdownTableBodyNone">Group that owns the shared volume dirs  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="autotoc_md466"></a>
Mandatory for AppleTalk</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Variable  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ATALKD_INTERFACE  </td><td class="markdownTableBodyNone">The network interface to use for AppleTalk  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="autotoc_md467"></a>
Optional</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md468"></a>
String</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Variable  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_UID  </td><td class="markdownTableBodyNone">Specify user id of AFP_USER  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">AFP_GID  </td><td class="markdownTableBodyNone">Specify group id of AFP_GROUP  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_USER2  </td><td class="markdownTableBodyNone">Username for the secondary user  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">AFP_PASS2  </td><td class="markdownTableBodyNone">Password for the secondary user  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SERVER_NAME  </td><td class="markdownTableBodyNone">The name of the server (AFP and Zeroconf)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SHARE_NAME  </td><td class="markdownTableBodyNone">The name of the primary shared volume  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SHARE_NAME2  </td><td class="markdownTableBodyNone">The name of the secondary shared (Time Machine) volume  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">AFP_LOGLEVEL  </td><td class="markdownTableBodyNone">The verbosity of logs; default is "info"  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_MIMIC_MODEL  </td><td class="markdownTableBodyNone">Use a custom macOS (OSX) AFP icon; examples: <em>Tower</em>, <em>RackMount</em>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">AFP_LEGACY_ICON  </td><td class="markdownTableBodyNone">Use a custom Classic Mac OS AFP icon; examples: <em>daemon</em>. <em>sdcard</em>  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_LOGIN_MESSAGE  </td><td class="markdownTableBodyNone">A message to display when a user logs in (Classic Mac OS)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ATALKD_OPTIONS  </td><td class="markdownTableBodyNone">A string with options to append to atalkd.conf  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_CNID_BACKEND  </td><td class="markdownTableBodyNone">The backend to use for the CNID database: <em>bdb</em> or <em>mysql</em>  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">AFP_CNID_SQL_HOST  </td><td class="markdownTableBodyNone">The hostname or IP address of the CNID SQL server  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_CNID_SQL_USER  </td><td class="markdownTableBodyNone">The username to use when connecting to the CNID SQL server  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">AFP_CNID_SQL_PASS  </td><td class="markdownTableBodyNone">The password to use when connecting to the CNID SQL server  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_CNID_SQL_DB  </td><td class="markdownTableBodyNone">The name of the designated database in the SQL server  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">TZ  </td><td class="markdownTableBodyNone">The <a href="https://nodatime.org/TimeZones">timezone</a> to use in the container  </td></tr>
</table>
<h3 class="doxsection"><a class="anchor" id="autotoc_md469"></a>
Boolean</h3>
<p>Set this environment variable to a non-zero value to enable, ex. "1"</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Variable  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AFP_DROPBOX  </td><td class="markdownTableBodyNone">Enable dropbox mode; secondary user is guest with read only access to the second shared volume  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">AFP_EXTMAP  </td><td class="markdownTableBodyNone">Enable mapping of filename extension to Classic Mac OS type/creator  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">INSECURE_AUTH  </td><td class="markdownTableBodyNone">Enable the "ClearTxt" and "Guest" UAMs; the AFP password must be 8 chars or shorter  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">DISABLE_TIMEMACHINE  </td><td class="markdownTableBodyNone">The secondary shared volume is a regular volume, not a backup volume  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MANUAL_CONFIG  </td><td class="markdownTableBodyNone">Enable manual management of configurations; overrides most other options  </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
