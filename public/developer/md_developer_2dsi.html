<!-- HTML header for doxygen 1.14.0-->
<!-- modified for netatalk -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.16.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>netatalk: DSI over TCP Implementation Notes</title>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<script
    src="https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js"
    integrity="sha384-o+g/BxPwhi0C3RK7oQBxQuNimeafQ3GE/ST4iT2BxVI4Wzt60SH4pq9iXVYujjaS"
    crossorigin="anonymous"
></script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
  <div id="projectrow">
    <div id="projectlogo">
      <a href="/"><img alt="Logo" src="logo.png"/></a>
    </div>
    <div id="projectalign">
      <div id="projectname">
        netatalk
        <span id="projectnumber">&#160;4.4.1</span>
      </div>
      <div id="projectbrief">Free and Open Source Apple Filing Protocol (AFP) Server</div>
    </div>
  </div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.16.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_developer_2dsi.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">DSI over TCP Implementation Notes </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1 class="doxsection"><a class="anchor" id="autotoc_md36"></a>
Signals and Writes to Client</h1>
<p>Because AFP/TCP uses a streaming protocol, we need to make sure that writes to the client are atomic. Notably, signal handlers which write data can't interrupt data currently being written. In addition, some functions get called from the signal handlers or can write partial packets. To avoid corruption, we need to make sure that these functions DO NOT touch any common-use buffers.</p>
<p>The <a class="el" href="struct_d_s_i.html">DSI</a> struct maintains an in_write counter that is incremented when entering write operations and decremented when leaving. Signal handlers check this flag to determine if it's safe to write to the socket.</p>
<p>Signals that send data to the client (<a class="el" href="afp__dsi_8c.html">afp_dsi.c</a>):</p>
<ul>
<li>SIGALRM (tickle handler)</li>
<li>SIGHUP (attention)</li>
<li>SIGTERM (attention)</li>
</ul>
<p>Functions which need their own buffers: <a class="el" href="include_2atalk_2dsi_8h.html#a0612f2dd4d16f369912daef047bc0672" title="send an attention.">dsi_attention()</a>, <a class="el" href="include_2atalk_2dsi_8h.html#a9a6e30b735d88093df70c14b0145f571">dsi_tickle()</a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md37"></a>
Performance Tweaking</h1>
<p>Sending complete packets or the header and a partial packet to the client is handled by <a class="el" href="include_2atalk_2dsi_8h.html#a354933e43ceb9e503bcb6b176cd2e91c" title="write data.">dsi_stream_send()</a> in <a class="el" href="dsi__stream_8c.html">dsi_stream.c</a>. <a class="el" href="include_2atalk_2dsi_8h.html#a354933e43ceb9e503bcb6b176cd2e91c" title="write data.">dsi_stream_send()</a> coalesces the header and data using writev(). In addition, AppleShare sessions often involve the sending and receiving of many small packets. As a consequence, TCP_NODELAY is used to speed up the turnaround time.</p>
<p>Because <a class="el" href="include_2atalk_2dsi_8h.html#a0e3adabf3642168ba72df020c12739c3" title="Read data from DSI buffer.">dsi_stream_read()</a> can send incomplete packets, <a class="el" href="include_2atalk_2dsi_8h.html#a354933e43ceb9e503bcb6b176cd2e91c" title="write data.">dsi_stream_send()</a> does not use the length parameter to specify the dsi_len field in the header. Instead, anything that uses <a class="el" href="include_2atalk_2dsi_8h.html#a354933e43ceb9e503bcb6b176cd2e91c" title="write data.">dsi_stream_send()</a> needs to specify dsi_len (in network byte order) before calling. The <a class="el" href="include_2atalk_2dsi_8h.html#a26755f716d2b186c981e6cf7a48c9916">dsi_send()</a> macro already does this.</p>
<p>Functions that need to specify .dsi_len: <a class="el" href="include_2atalk_2dsi_8h.html#a48c9509fc4d43c70abd31f83216e3029" title="streaming i/o for afp_read.">dsi_readinit()</a>, <a class="el" href="include_2atalk_2dsi_8h.html#adceb0fbb83e53f395704c8783d918690">dsi_cmdreply()</a></p>
<p>To reduce the amount of tickles generated on a slow link, SIGALRM is turned off for the duration of a "known" large file transfer (i.e., dsi_read/write).</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md38"></a>
Read-Ahead Buffering</h1>
<p><a class="el" href="struct_d_s_i.html">DSI</a> implements a read-ahead buffer to reduce the number of small reads. The buffer size is controlled by the dsireadbuf option (default 12, meaning 12 Ã— server quantum). When a read would block due to EAGAIN/EWOULDBLOCK, <a class="el" href="dsi__stream_8c.html#a0aa521be4781a7758a104267ae14f36b" title="Check if we can write to the DSI socket.">dsi_peek()</a> attempts to read data from the client to break potential deadlock situations. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- HTML footer for doxygen 1.14.0-->
<!-- modified for netatalk -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.16.1 </li>
  </ul>
</div>
</body>
</html>
