<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>netatalk: Setting up Netatalk</title>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">netatalk<span id="projectnumber">&#160;4.4.0dev</span>
   </div>
   <div id="projectbrief">Free and Open Source Apple Filing Protocol (AFP) Server</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_manual_2_configuration.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Setting up Netatalk </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md395"></a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md396"></a>
Setting up the AFP file server</h1>
<p>AFP (the Apple Filing Protocol) is a protocol used on the Apple Macintosh for file services. The protocol has evolved over the years. The final revision of the protocol, AFP 3.4, was introduced with OS X Lion (10.7).</p>
<p>Netatalk's <b>afpd</b> daemon offers AFP fileservices to Apple clients. The configuration is managed through the <em>afp.conf</em> file which uses an ini style configuration syntax.</p>
<p>Netatalk provides compatibility with Time Machine for remote backups, and Spotlight for indexed searching.</p>
<p>To make a volume a Time Machine target, use the volume option <b>time machine = yes</b>.</p>
<p>To enable Spotlight indexing globally or for a volume, set the option <b>spotlight = yes</b> where appropriate.</p>
<p>Starting with Netatalk 2.1, UNIX symlinks can be used on the server. Semantics are the same as for e.g. NFS, i.e. they are not resolved on the server side but instead it's completely up to the client to resolve them, resulting in links that point somewhere inside the client's filesystem view.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md397"></a>
afp.conf</h2>
<p><em>afp.conf</em> is the configuration file used by afpd to determine the behaviour and configuration of the AFP file server and the AFP volume that it provides.</p>
<p>The <em>afp.conf</em> is divided into several sections:</p>
<p>[Global]</p>
<blockquote class="doxtable">
<p>The global section defines general server options </p>
</blockquote>
<p>[Homes]</p>
<blockquote class="doxtable">
<p>The homes section defines user home volumes </p>
</blockquote>
<p>Any section not called <b>Global</b> or <b>Homes</b> is interpreted as an AFP volume.</p>
<p>For sharing user homes by defining a <b>Homes</b> section you must specify the option <b>basedir regex</b> which can be a simple string with the path to the parent directory of all user homes or a regular expression.</p>
<p>Example: </p><pre class="fragment">[Homes]
basedir regex = /home
</pre><p>Now any user logging into the AFP server will have a user volume available whose path is <span class="tt">/home/NAME</span>.</p>
<p>A more complex setup would be a server with a large amount of user homes which are split across e.g. two different filesystems:</p>
<ul>
<li>/RAID1/homes</li>
<li>/RAID2/morehomes</li>
</ul>
<p>The following configuration is required: </p><pre class="fragment">[Homes]
basedir regex = /RAID./.*homes
</pre><p>If <b>basedir regex</b> contains a symlink, set the canonicalized absolute path. When */home* links to */usr/home*: </p><pre class="fragment">[Homes]
basedir regex = /usr/home
</pre><p>For a more detailed explanation of the available options, please refer to the <a href="afp.conf.5.html">afp.conf</a> man page.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md398"></a>
CNID backends</h1>
<p>Unlike other protocols like SMB or NFS, the AFP protocol mostly refers to files and directories by ID and not by a path. These IDs are called CNID, which stand for Catalog Node ID. A typical AFP request uses a directory ID and a filename, something like "server, please open the file named 'Test' in the
directory with id 167". For example "Aliases" on the Mac basically work by ID (with a fallback to the absolute path in more recent AFP clients. But this applies only to Finder, not to applications).</p>
<p>Every file in an AFP volume has to have a unique file ID. CNIDs must, according to the AFP specification, never be reused. The IDs are represented as 32 bit numbers, and directory IDs use the same ID pool. So, after ~4 billion files/folders have been written to an AFP volume, the ID pool is depleted and no new file can be written to the volume. Some of Netatalk's CNID backends may attempt to reuse available IDs after depletion, which is technically in violation of the spec, but may enable continuous use on long-lived volumes.</p>
<p>Netatalk needs to map IDs to files and folders in the host filesystem. To achieve this, several different CNID backends are available and can be selected with the <b>cnid scheme</b> option in the <em>afp.conf</em> configuration file. A CNID backend is basically a database storing ID &lt;-&gt; name mappings.</p>
<p>For the CNID backends which use a zero-configuration database, the database files are by default located in a <em>netatalk/CNID</em> subdirectory of your system's state directory path, e.g. */var/lib*. You can change the state directory path with <em>-Dwith-statedir-path=PATH</em> at compile time.</p>
<p>There is a command line utility called <b>dbd</b> available which can be used to verify, repair and rebuild the CNID database.</p>
<p><em><b>NOTE:</b></em> There are some CNID related things you should keep in mind when working with netatalk:</p>
<ul>
<li>Don't nest volumes unless "**vol dbnest = yes**" is set.</li>
<li>CNID backends are databases, so they turn afpd into a file server/database mix.</li>
<li>If there's no more space on the filesystem left, the database will get corrupted. You can work around this by using the <b>vol dbpath</b> option and put the database files into another location.</li>
<li>Be careful with CNID databases for volumes that are mounted via NFS. That is a pretty audacious decision to make anyway, but putting a database there as well is really asking for trouble, i.e. database corruption. Use the <b>vol dbpath</b> directive to put the databases onto a local disk if you must use NFS mounted volumes.</li>
</ul>
<p>Below follows descriptions of the various CNID backends that are included with netatalk. You can choose to build one or several of them at compile time. Run the command <em>afpd -v</em> to see which backends are available to you, as well as which one is the default.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md399"></a>
dbd</h2>
<p>The "Database Daemon" backend is built on Berkeley DB. Access to the CNID database is restricted to the <b>cnid_dbd</b> daemon process. <b>afpd</b> processes communicate with the <b>cnid_dbd</b> daemon for database reads and updates, which is in turn launched and controlled by the <b>cnid_metad</b> daemon.</p>
<p>This is the most reliable and proven backend for daily use.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md400"></a>
sqlite</h2>
<p>A performant and lean CNID database backend that uses the SQLite v3 embedded database engine.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md401"></a>
mysql</h2>
<p>CNID backend using a MySQL server. The MySQL server has to be provisioned by the system administrator, and Netatalk configured to connect to it over the network.</p>
<p>See <b>afp.conf</b>(5) for documentation of the configuration options.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md402"></a>
last</h2>
<p>The last backend is an in-memory Trivial Database (tdb). It is not persistent, with IDs valid only for the current session. Starting with netatalk 3.0, it operates in <em>read only mode</em>. This backend is useful e.g. for mounting CD-ROMs, or for automated testing.</p>
<p>This is basically equivalent to how <b>afpd</b> stored CNID data in netatalk 1.5 and earlier.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md403"></a>
Charsets/Unicode</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md404"></a>
Why Unicode?</h2>
<p>Internally, computers don't know anything about characters and texts, they only know numbers. Therefore, each letter is assigned a number. A character set, often referred to as <em>charset</em> or <em>codepage</em>, defines the mappings between numbers and letters.</p>
<p>If two or more computer systems need to communicate with each other, the have to use the same character set. In the 1960s the ASCII (American Standard Code for Information Interchange) character set was defined by the American Standards Association. The original form of ASCII represented 128 characters, more than enough to cover the English alphabet and numerals. Up to date, ASCII has been the normative character scheme used by computers.</p>
<p>Later versions defined 256 characters to produce a more international fluency and to include some slightly esoteric graphical characters. Using this mode of encoding each character takes exactly one byte. Obviously, 256 characters still wasn't enough to map all the characters used in the various languages into one character set.</p>
<p>As a result localized character sets were defined later, e.g the ISO-8859 character sets. Most operating system vendors introduced their own characters sets to satisfy their needs, e.g. IBM defined the <em>codepage 437 (DOSLatinUS)</em>, Apple introduced the <em>MacRoman</em> codepage and so on. The characters that were assigned number larger than 127 were referred to as <em>extended</em> characters. These character sets conflict with another, as they use the same number for different characters, or vice versa.</p>
<p>Almost all of those characters sets defined 256 characters, where the first 128 (0-127) character mappings are identical to ASCII. As a result, communication between systems using different codepages was effectively limited to the ASCII charset.</p>
<p>To solve this problem new, larger character sets were defined. To make room for more character mappings, these character sets use at least 2 bytes to store a character. They are therefore referred to as <em>multibyte</em> character sets.</p>
<p>One standardized multibyte charset encoding scheme is known as <a href="http://www.unicode.org/">Unicode</a>. A big advantage of using a multibyte charset is that you only need one. There is no need to make sure two computers use the same charset when they are communicating.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md405"></a>
Character sets used by Apple</h2>
<p>In the past, Apple clients used single-byte charsets to communicate over the network. Over the years Apple defined a number of codepages, western users will most likely be using the <em>MacRoman</em> codepage.</p>
<p>Codepages defined by Apple include:</p>
<ul>
<li>MacArabic, MacFarsi</li>
<li>MacCentralEurope</li>
<li>MacChineseSimple</li>
<li>MacChineseTraditional</li>
<li>MacCroatian</li>
<li>MacCyrillic</li>
<li>MacDevanagari</li>
<li>MacGreek</li>
<li>MacHebrew</li>
<li>MacIcelandic</li>
<li>MacJapanese</li>
<li>MacKorean</li>
<li>MacRoman</li>
<li>MacRomanian</li>
<li>MacThai</li>
<li>MacTurkish</li>
</ul>
<p>Starting with Mac OS X and AFP3, <a href="http://www.utf-8.com/">UTF-8</a> is used. UTF-8 encodes Unicode characters in an ASCII compatible way, each Unicode character is encoded into 1-6 ASCII characters. UTF-8 is therefore not really a charset itself, it's an encoding of the Unicode charset.</p>
<p>To complicate things, Unicode defines several <em><a href="http://www.unicode.org/reports/tr15/index.html">normalization</a></em> forms. While <a href="http://www.samba.org">samba</a> uses <em>precomposed</em> Unicode, which most UNIX tools prefer as well, Apple decided to use the <em>decomposed</em> normalization.</p>
<p>For example lets take the character 'ä' (lowercase a with diaeresis). Using the precomposed normalization, Unicode maps this character to 0xE4. In decomposed normalization, 'ä' is actually mapped to two characters, 0x61 is the mapping for an 'a', 0x308 is the mapping for a <em>COMBINING DIAERESIS</em>.</p>
<p>Netatalk refers to precomposed UTF-8 as <em>UTF8</em> and to decomposed UTF-8 as <em>UTF8-MAC</em>.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md406"></a>
afpd and character sets</h2>
<p>To support new AFP 3.x and older AFP 2.x clients at the same time, afpd needs to be able to convert between the various charsets used. AFP 3.x clients always use UTF8-MAC, while AFP 2.x clients use one of the Apple codepages.</p>
<p>At the time of writing, netatalk supports the following Apple codepages:</p>
<ul>
<li>MAC_CENTRALEUROPE</li>
<li>MAC_CHINESE_SIMP</li>
<li>MAC_CHINESE_TRAD</li>
<li>MAC_CYRILLIC</li>
<li>MAC_GREEK</li>
<li>MAC_HEBREW</li>
<li>MAC_JAPANESE</li>
<li>MAC_KOREAN</li>
<li>MAC_ROMAN</li>
<li>MAC_TURKISH</li>
</ul>
<p>afpd handles three different character set options:</p>
<p>unix charset</p>
<blockquote class="doxtable">
<p>This is the codepage used internally by your operating system. If not specified, it defaults to <b>UTF8</b>. If <b>LOCALE</b> is specified and your system support UNIX locales, afpd tries to detect the codepage. afpd uses this codepage to read its configuration files, so you can use extended characters for volume names, login messages, etc. </p>
</blockquote>
<p>mac charset</p>
<blockquote class="doxtable">
<p>As already mentioned, older Mac OS clients (up to AFP 2.2) use codepages to communicate with afpd. However, there is no support for negotiating the codepage used by the client in the AFP protocol. If not specified otherwise, afpd assumes the <em>MacRoman</em> codepage is used. In case your clients use another codepage, e.g. <em>MacCyrillic</em>, you'll <b>have</b> to explicitly configure this. </p>
</blockquote>
<p>vol charset</p>
<blockquote class="doxtable">
<p>This defines the charset afpd should use for filenames on disk. By default, it is the same as <b>unix charset</b>. If you have <a href="http://www.gnu.org/software/libiconv/">iconv</a> installed, you can use any iconv provided charset as well. </p>
</blockquote>
<p>afpd needs a way to preserve extended Macintosh characters, or characters illegal in UNIX filenames, when saving files on a UNIX filesystem. Earlier versions used the the so called CAP encoding. An extended character (&gt;0x7F) would be converted to a :xx hex sequence, e.g. the Apple Logo (MacRoman: 0xF0) was saved as :f0. Some special characters will be converted as to :xx notation as well. '/' will be encoded to :2f, if <b>usedots</b> was not specified, a leading dot '.' will be encoded as :2e.</p>
<p>Even though this version now uses <b>UTF8</b> as the default encoding for filenames, '/' will be converted to ':'. For western users another useful setting could be <b>vol charset = ISO-8859-15</b>.</p>
<p>If a character cannot be converted from the <b>mac charset</b> to the selected <b>vol charset</b>, you'll receive a -50 error on the Mac. <em>Note</em>: Whenever you can, please stick with the default UTF8 volume format.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md407"></a>
Authentication</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md408"></a>
AFP authentication basics</h2>
<p>Apple chose a flexible model called "User Authentication
Modules" (UAMs) for authentication purposes between AFP client and server. An AFP client initially connecting to an AFP server will ask for the list of UAMs which the server provides, and will choose the one with strongest encryption that the client supports.</p>
<p>Several UAMs have been developed by Apple over the time, some by 3rd-party developers.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md409"></a>
UAMs supported by Netatalk</h2>
<p>Netatalk supports the following ones by default:</p>
<ul>
<li>"No User Authent" UAM (guest access without authentication)</li>
<li>"Cleartxt Passwrd" UAM (no password encryption)</li>
<li>"Randnum exchange"/"2-Way Randnum exchange" UAMs (weak password encryption, separate password storage)</li>
<li>"DHCAST128" UAM (a.k.a. DHX; stronger password encryption)</li>
<li>"DHX2" UAM (successor of DHCAST128)</li>
</ul>
<p>There exist other optional UAMs as well:</p>
<ul>
<li>"Client Krb v2" UAM (Kerberos V, suitable for "Single Sign On" Scenarios with macOS clients – see below)</li>
</ul>
<p>You can configure which UAMs should be activated by defining "**uam list**" in <b>Global</b> section. <b>afpd</b> will log which UAMs it's using and if problems occur while activating them in either <b>netatalk.log</b> or syslog at startup time. <b>asip-status</b> can be used to query the available UAMs of AFP servers as well.</p>
<p>Having a specific UAM available at the server does not automatically mean that a client can use it. Client-side support is also necessary. For older Macintoshes running Classic Mac OS, DHCAST128 support exists since AppleShare client 3.8.x.</p>
<p>On macOS, there exist some client-side techniques to make the AFP-client more verbose, so one can have a look at what's happening while negotiating the UAMs to use. Compare with this <a href="https://web.archive.org/web/20080312054723/http://article.gmane.org/gmane.network.netatalk.devel/7383/">hint</a>.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md410"></a>
Which UAMs to activate?</h2>
<p>It depends primarily on your needs and on the kind of macOS clients you have to support. If your network consists of exclusively macOS (Mac OS X) clients, DHX2 is sufficient, and provides the strongest encryption.</p>
<ul>
<li><p class="startli">Unless you really have to supply guest access to your server's volumes ensure that you disable "No User Authent" since it might lead accidentally to unauthorized access. In case you must enable guest access take care that you enforce this on a per volume base using the access controls.</p>
<p class="startli">Note: "No User Authent" is required to use Apple II NetBoot services (<b>a2boot</b>) to boot an Apple //e over AFP.</p>
</li>
<li><p class="startli">The "ClearTxt Passwrd" UAM is as bad as it sounds since passwords go unencrypted over the wire. Try to avoid it at both the server's side as well as on the client's.</p>
<p class="startli">Note: If you want to provide Mac OS 8/9 clients with NetBoot-services then you need uams_cleartxt.so since the AFP-client integrated into the Mac's firmware can only deal with this basic form of authentication.</p>
</li>
<li><p class="startli">Since "Randnum exchange"/"2-Way Randnum exchange" uses only 56 bit DES for encryption it should be avoided as well. Another disadvantage is the fact that the passwords have to be stored in cleartext on the server and that it doesn't integrate into both PAM scenarios or classic /etc/shadow (you have to administrate passwords separately by using the <b>afppasswd</b> utility, in order for clients to use these UAMs)</p>
<p class="startli">However, this is the strongest form of authentication that can be used with Macintosh System Software 7.1 or earlier.</p>
</li>
<li>"DHCAST128" ("DHX") or "DHX2" should be the sweet spot for most people since it combines stronger encryption with PAM integration.</li>
<li>Using the Kerberos V ("Client Krb v2") UAM, it's possible to implement real single sign on scenarios using Kerberos tickets. The password is not sent over the network. Instead, the user password is used to decrypt a service ticket for the AppleShare server. The service ticket contains an encryption key for the client and some encrypted data (which only the AppleShare server can decrypt). The encrypted portion of the service ticket is sent to the server and used to authenticate the user. Because of the way that the afpd service principal detection is implemented, this authentication method is vulnerable to man-in-the-middle attacks.</li>
</ul>
<p>For a more detailed overview over the technical implications of the different UAMs, please have a look at Apple's <a href="http://developer.apple.com/library/mac/#documentation/Networking/Conceptual/AFP/AFPSecurity/AFPSecurity.html#//apple_ref/doc/uid/TP40000854-CH232-SW1">File Server Security</a> pages.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md411"></a>
Using different authentication sources with specific UAMs</h2>
<p>Some UAMs provide the ability to use different authentication "backends", namely <b>uams_clrtxt.so</b>, <b>uams_dhx.so</b> and <b>uams_dhx2.so</b>. They can use either classic UNIX passwords from */etc/passwd* (*/etc/shadow*) or PAM if the system supports that. <b>uams_clrtxt.so</b> can be symlinked to either <b>uams_passwd.so</b> or <b>uams_pam.so</b>, <b>uams_dhx.so</b> to <b>uams_dhx_passwd.so</b> or <b>uams_dhx_pam.so</b> and <b>uams_dhx2.so</b> to <b>uams_dhx2_passwd.so</b> or <b>uams_dhx2_pam.so</b>.</p>
<p>So, if it looks like this in Netatalk's UAMs folder (per default */etc/netatalk/uams/*) then you're using PAM, otherwise classic UNIX passwords. </p><pre class="fragment">uams_clrtxt.so -&gt; uams_pam.so
uams_dhx.so -&gt; uams_dhx_pam.so
uams_dhx2.so -&gt; uams_dhx2_pam.so
</pre><p>The main advantage of using PAM is that one can integrate Netatalk in centralized authentication scenarios, e.g. via LDAP, NIS and the like. Please always keep in mind that the protection of your user's login credentials in such scenarios also depends on the strength of encryption that the UAM in question supplies. So think about eliminating weak UAMs like "ClearTxt Passwrd" and "Randnum exchange" completely from your network.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md412"></a>
Netatalk UAM overview table</h2>
<p>A small overview of the officially supported UAMs.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">UAM  </th><th class="markdownTableHeadNone">No User Auth  </th><th class="markdownTableHeadNone">Cleartxt Passwrd  </th><th class="markdownTableHeadNone">RandNum Exchange  </th><th class="markdownTableHeadNone">DHCAST128  </th><th class="markdownTableHeadNone">DHX2  </th><th class="markdownTableHeadNone">Kerberos V  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Password length  </td><td class="markdownTableBodyNone">guest access  </td><td class="markdownTableBodyNone">max 8 chars  </td><td class="markdownTableBodyNone">max 8 chars  </td><td class="markdownTableBodyNone">max 64 chars  </td><td class="markdownTableBodyNone">max 256 chars  </td><td class="markdownTableBodyNone">Kerberos tickets  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Client support  </td><td class="markdownTableBodyNone">built-in into all Mac OS versions  </td><td class="markdownTableBodyNone">built-in in all Mac OS versions except 10.0. Has to be activated explicitly in later Mac OS X versions  </td><td class="markdownTableBodyNone">built-in into almost all Mac OS versions  </td><td class="markdownTableBodyNone">built-in since AppleShare client 3.8.4, available as a plug-in for 3.8.3, integrated in macOS's AFP client  </td><td class="markdownTableBodyNone">built-in since Mac OS X 10.2  </td><td class="markdownTableBodyNone">built-in since Mac OS X 10.2  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Encryption  </td><td class="markdownTableBodyNone">Enables guest access without authentication between client and server.  </td><td class="markdownTableBodyNone">Password will be sent in cleartext over the wire. Just as bad as it sounds, therefore avoid at all if possible (note: providing NetBoot services requires the ClearTxt UAM)  </td><td class="markdownTableBodyNone">8-byte random numbers are sent over the wire, comparable with DES, 56 bits. Vulnerable to offline dictionary attack. Requires passwords in clear on the server.  </td><td class="markdownTableBodyNone">Password will be encrypted with 128 bit SSL, user will be authenticated against the server but not vice versa. Therefore weak against man-in-the-middle attacks.  </td><td class="markdownTableBodyNone">Password will be encrypted using libgcrypt with CAST 128 in CBC mode. User will be authenticated against the server but not vice versa. Therefore weak against man-in-the-middle attacks.  </td><td class="markdownTableBodyNone">Password is not sent over the network. Due to the service principal detection method, this authentication method is vulnerable to man-in-the-middle attacks.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Server support  </td><td class="markdownTableBodyNone">uams_guest.so  </td><td class="markdownTableBodyNone">uams_cleartxt.so  </td><td class="markdownTableBodyNone">uams_randnum.so  </td><td class="markdownTableBodyNone">uams_dhx.so  </td><td class="markdownTableBodyNone">uams_dhx2.so  </td><td class="markdownTableBodyNone">uams_gss.so  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Password storage  </td><td class="markdownTableBodyNone">None  </td><td class="markdownTableBodyNone">Either system auth or PAM  </td><td class="markdownTableBodyNone">Passwords stored in clear text in a separate text file  </td><td class="markdownTableBodyNone">Either system auth or PAM  </td><td class="markdownTableBodyNone">Either system auth or PAM  </td><td class="markdownTableBodyNone">At the Kerberos Key Distribution Center  </td></tr>
</table>
<h1 class="doxsection"><a class="anchor" id="autotoc_md413"></a>
ACL Support</h1>
<p>ACL support for AFP is implemented for ZFS ACLs on Solaris and derived platforms and for POSIX 1e ACLs on Linux.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md414"></a>
Configuration</h2>
<p>For a basic mode of operation there's nothing to configure. Netatalk reads ACLs on the fly and calculates effective permissions which are then send to the AFP client via the so called UARights permission bits. On a Mac, the Finder uses these bits to adjust permission in Finder windows. Example: a folder whose UNIX mode is read-only and an ACL giving the user write access, will display the effective read-write permission. Without the permission mapping the Finder would display a read-only icon and the user wouldn't be able to write to the folder.</p>
<p>By default, the effective permission of the authenticated user are only mapped to the mentioned UARightspermission structure, not the UNIX mode. You can adjust this behaviour with the configuration option <a href="afp.conf#options-for-acl-handling">map acls</a>.</p>
<p>However, neither in Finder "Get Info" windows nor in the Terminal will you be able to see the ACLs, because of how ACLs in macOS are designed. If you want to be able to display ACLs on the client, things get more involved as you must then setup both client and server to be part on a authentication domain (directory service, e.g. LDAP, OpenDirectory). The reason is, that in macOS ACLs are bound to UUIDs, not just uid's or gid's. Therefore afpd must be able to map every filesystem uid and gid to a UUID so that it can return the server side ACLs which are bound to UNIX uid and gid mapped to macOS UUIDs.</p>
<p>Netatalk can query a directory server using LDAP queries. Either the directory server already provides an UUID attribute for user and groups (Active Directory, Open Directory) or you reuse an unused attribute (or add a new one) to you directory server (e.g. OpenLDAP).</p>
<p>In detail:</p>
<ol type="1">
<li><p class="startli">For Solaris/ZFS: ZFS Volumes</p>
<p class="startli">You should configure a ZFS ACL know for any volume you want to use with Netatalk: </p><pre class="fragment">aclinherit = passthrough
aclmode = passthrough
</pre><p class="startli">For an explanation of what this knob does and how to apply it, check your hosts ZFS documentation (e.g. man zfs).</p>
</li>
<li><p class="startli">Authentication Domain</p>
<p class="startli">Your server and the clients must be part of a security association where identity data is coming from a common source. ACLs in Darwin are based on UUIDs and so is the ACL specification in AFP 3.2. Therefore your source of identity data has to provide an attribute for every user and group where a UUID is stored as a ASCII string. In other words:</p><ul>
<li>you need an Open Directory Server or an LDAP server where you store UUIDs in some attribute</li>
<li>your clients must be configured to use this server</li>
<li>your server should be configured to use this server via nsswitch and PAM</li>
<li>configure Netatalk via the special <a href="afp.conf.html#options-for-acl-handling">LDAP options for ACLs</a> in <em>afp.conf</em> so that Netatalk is able to retrieve the UUID for users and groups via LDAP search queries</li>
</ul>
</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md415"></a>
macOS ACLs</h2>
<p>With Access Control Lists (ACLs), macOS offers a powerful extension of the traditional UNIX permissions model. An ACL is an ordered list of Access Control Entries (ACEs) explicitly granting or denying a set of permissions to a given user or group.</p>
<p>Unlike UNIX permissions, which are bound to user or group IDs, ACLs are tied to UUIDs. For this reason accessing an object's ACL requires server and client to use a common directory service which translates between UUIDs and user/group IDs.</p>
<p>ACLs and UNIX permissions interact in a rather simple way. As ACLs are optional UNIX permissions act as a default mechanism for access control. Changing an objects's UNIX permissions will leave its ACL intact and modifying an ACL will never change the object's UNIX permissions. While doing access checks, macOS first examines an object's ACL evaluating ACEs in order until all requested rights have been granted, a requested right has been explicitly denied by an ACE or the end of the list has been reached. In case there is no ACL or the permissions granted by the ACL are not sufficient to fulfill the request, macOS next evaluates the object's UNIX permissions. Therefore ACLs always have precedence over UNIX permissions.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md416"></a>
ZFS ACLs</h2>
<p>ZFS ACLs closely match macOS ACLs. Both offer mostly identical fine grained permissions and inheritance settings.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md417"></a>
POSIX ACLs</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md418"></a>
Overview</h3>
<p>Compared to macOS or NFSv4 ACLs, POSIX ACLs represent a different, less versatile approach to overcome the limitations of the traditional UNIX permissions. Implementations are based on the withdrawn POSIX 1003.1e standard.</p>
<p>The standard defines two types of ACLs. Files and directories can have access ACLs which are consulted for access checks. Directories can also have default ACLs irrelevant to access checks. When a new object is created inside a directory with a default ACL, the default ACL is applied to the new object as its access ACL. Subdirectories inherit default ACLs from their parent. There are no further mechanisms of inheritance control.</p>
<p>Architectural differences between POSIX ACLs and macOS ACLs especially involve:</p>
<ul>
<li>No fine-granular permissions model. Like UNIX permissions POSIX ACLs only differentiate between read, write and execute permissions.</li>
<li>Entries within an ACL are unordered.</li>
<li>POSIX ACLs can only grant rights. There is no way to explicitly deny rights by an entry.</li>
<li>UNIX permissions are integrated into an ACL as special entries.</li>
</ul>
<p>POSIX 1003.1e defines 6 different types of ACL entries. The first three types are used to integrate standard UNIX permissions. They form a minimal ACL, their presence is mandatory and only one entry of each type is allowed within an ACL.</p>
<ul>
<li>ACL_USER_OBJ: the owner's access rights.</li>
<li>ACL_GROUP_OBJ: the owning group's access rights.</li>
<li>ACL_OTHER: everybody's access rights.</li>
</ul>
<p>The remaining entry types expand the traditional permissions model:</p>
<ul>
<li>ACL_USER: grants access rights to a certain user.</li>
<li>ACL_GROUP: grants access rights to a certain group.</li>
<li>ACL_MASK: limits the maximum access rights which can be granted by entries of type ACL_GROUP_OBJ, ACL_USER and ACL_GROUP. As the name suggests, this entry acts as a mask. Only one ACL_MASK entry is allowed per ACL. If an ACL contains ACL_USER or ACL_GROUP entries, an ACL_MASK entry must be present too, otherwise it is optional.</li>
</ul>
<p>In order to maintain compatibility with applications not aware of ACLs, POSIX 1003.1e changes the semantics of system calls and utilities which retrieve or manipulate an object's UNIX permissions. In case an object only has a minimal ACL, the group permissions bits of the UNIX permissions correspond to the value of the ACL_GROUP_OBJ entry.</p>
<p>However, if the ACL also contains an ACL_MASK entry, the behavior of those system calls and utilities is different. The group permissions bits of the UNIX permissions correspond to the value of the ACL_MASK entry, i. e. calling "chmod g-w" will not only revoke write access for the group, but for all entities which have been granted write access by ACL_USER or ACL_GROUP entries.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md419"></a>
Mapping POSIX ACLs to macOS ACLs</h3>
<p>When a client wants to read an object's ACL, afpd maps its POSIX ACL onto an equivalent macOS ACL. Writing an object's ACL requires afpd to map an macOS ACL onto a POSIX ACL. Due to architectural restrictions of POSIX ACLs, it is usually impossible to find an exact mapping so that the result of the mapping process will be an approximation of the original ACL's semantic.</p>
<ul>
<li>afpd silently discard entries which deny a set of permissions because they they can't be represented within the POSIX architecture.</li>
<li>As entries within POSIX ACLs are unordered, it is impossible to preserve order.</li>
<li>Inheritance control is subject to severe limitations as well:<ul>
<li>Entries with the only_inherit flag set will only become part of the directory's default ACL.</li>
<li>Entries with at least one of the flags file_inherit, directory_inherit or limit_inherit set, will become part of the directory's access and default ACL, but the restrictions they impose on inheritance will be ignored.</li>
</ul>
</li>
<li>The lack of a fine-granular permission model on the POSIX side will normally result in an increase of granted permissions.</li>
</ul>
<p>As macOS clients aren't aware of the POSIX 1003.1e specific relationship between UNIX permissions and ACL_MASK, afpd does not expose this feature to the client to avoid compatibility issues and handles *unix permissions and ACLs the same way as Apple's reference implementation of AFP does. When an object's UNIX permissions are requested, afpd calculates proper group rights and returns the result together with the owner's and everybody's access rights to the caller via "permissions" and "ua_permissions" members of the FPUnixPrivs structure (see Apple Filing Protocol Reference, page 181). Changing an object's permissions, afpd always updates ACL_USER_OBJ, ACL_GROUP_OBJ and ACL_OTHERS. If an ACL_MASK entry is present too, afpd recalculates its value so that the new group rights become effective and existing entries of type ACL_USER or ACL_GROUP stay intact.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md420"></a>
Directory Cache Tuning</h1>
<p>The dircache (Directory Cache) in Netatalk provides a cache of the full paths for all files and directories enumerated by a user. Once populated during the first directory enumeration, subsequent enumerations can be delivered directly from memory. This enables fast responses even when working with very large directories. When a user renames/deletes files and directories, the dircache entries are updated/removed immediately.</p>
<p>While the dircache is kept in sync with AFP operations, it is unable to detect external changes outside of Netatalk (eg, local file changes, or changes using other file sharing services like Samba). As a result, Netatalk performs a stat() operation to validate a dircache entry is still valid, every single time a cache entry is read. This impacts the benefits and effectiveness of the dircache.</p>
<p>For setups where Netatalk is the only accessor, or where external file changes are infrequent, the additional file stat operations are mostly redundant, and can be safely tuned down. This significantly reduces IO operations on storage/page-cache/ZFS ARC layers.</p>
<p><b>If a dircache entry is found to be stale when used, the invalid_on_use counter is incremented, and the dircache entry is transparently rebuilt.</b> You can use the invalid_on_use counter to tune <span class="tt">dircache validation freq</span>.</p>
<p>dircachesize = <em>number</em> <b>(G)</b></p>
<p>Maximum possible entries in the directory cache. The cache stores directories and files. It is used to cache the full path to directories and CNIDs which considerably speeds up directory enumeration. Given value is rounded up to nearest power of 2. Each entry takes about 100 bytes, which is not much, but remember that every afpd child process for every connected user has its own cache.</p>
<p>Default: 8192, Maximum size: 131072.</p>
<p>dircache validation freq = <em>number</em> <b>(G)</b></p>
<p>Directory cache validation frequency for external change detection. Controls how often cached entries are validated against the filesystem to detect changes made outside of netatalk (e.g., direct filesystem modifications by other processes). A value of 1 means validate cache every access (default for backward compatibility which performs a stat() operation on the storage object to validate the cache every cache read), higher values validate less frequently. For example, 5 means validate cache entries every 5th access. Higher values improve performance and significantly reduce storage IO and page cache stress, but may delay detection of changes external from Netatalk.</p>
<p>Default: 1, Range: 1-100.</p>
<p>Internal netatalk operations (file/directory create, delete, rename) always invalidate dircache entries immediately regardless of this setting. If Netatalk is the only process accessing the volume you can safely set a value of 100 for maximum performance.</p>
<p>dircache metadata window = <em>number</em> <b>(G)</b></p>
<p>Time window in seconds for distinguishing metadata-only changes from content changes in directories. When a directory's ctime changes within this window from the current time, the change is considered potentially metadata-only (permissions, extended attributes) rather than content modification. Smaller values are more conservative but may cause unnecessary cache invalidation. Larger values improve performance but may retain stale entries longer.</p>
<p>Default: 300 seconds (5 minutes). Range: 60-3600 seconds.</p>
<p>If Netatalk is the only process accessing the volume you can safely set a value of 3600.</p>
<p>dircache metadata threshold = <em>number</em> <b>(G)</b></p>
<p>Maximum time difference in seconds between cached and current directory ctime to be considered a metadata-only change. Works together with dircache metadata window to avoid invalidating cache entries for minor metadata modifications. This prevents cache invalidation for small, recent ctime changes that are likely due to more frequent permission or extended attribute modifications rather than directory content changes.</p>
<p>Default: 60 seconds (1 minute). Range: 10-1800 seconds.</p>
<p>If Netatalk is the only process accessing the volume you can safely set a value of 1800.</p>
<p><b>Example</b> (Netatalk only access to volume): dircache validation freq = 100 dircache metadata window = 3600 dircache metadata threshold = 1800</p>
<p><b>Note</b>: Monitor dircache effectiveness by checking Netatalk log files for "dircache statistics:" lines when afpd shuts down gracefully (user disconnects).</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md421"></a>
Filesystem Change Events</h1>
<p>Netatalk includes a nifty filesystem change event (FCE) mechanism where afpd processes notify interested listeners about certain filesystem events by UDP network datagrams.</p>
<p>This feature is disabled by default. To enable it, set the <b>fce listener</b> option in afp.conf to the hostname or IP address of the host that should listen for FCE events.</p>
<p>Netatalk distributes a simple FCE listener application called <b>fce_listen</b>. It will print out any UDP datagrams received from the AFP server. Its source code also serves as documentation for the format of the UDP packets.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md422"></a>
FCE v1</h2>
<p>The currently supported FCE v1 events are:</p>
<ul>
<li>file modification (fmod)</li>
<li>file deletion (fdel)</li>
<li>directory deletion (ddel)</li>
<li>file creation (fcre)</li>
<li>directory creation (dcre)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md423"></a>
FCE v2</h2>
<p>FCE v2 events provide additional context such as the user who performed the action. When using FCE v2 you also get the following events:</p>
<ul>
<li>file moving (fmov)</li>
<li>directory moving (dmov)</li>
<li>user login (login)</li>
<li>user logout (logout)</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md424"></a>
Spotlight Compatible Search</h1>
<p>You can enable Netatalk's Spotlight compatible search and indexing either globally or on a per volume basis with the <b>spotlight</b> option.</p>
<blockquote class="doxtable">
<p><em><b>WARNING:</b></em> Once Spotlight is enabled for a single volume, all other volumes for which spotlight is disabled won't be searchable at all. </p>
</blockquote>
<p>The <b>dbus-daemon</b> binary has to be installed for Spotlight feature. The path to dbus-daemon is determined at compile time the dbus-daemon build system option.</p>
<p>In case the <b>dbus-daemon</b> binary is installed at the other path, you must use the global option <b>dbus daemon</b> to point to the path, e.g. for Solaris with Tracker from OpenCSW: </p><pre class="fragment">dbus daemon = /opt/csw/bin/dbus-daemon
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
